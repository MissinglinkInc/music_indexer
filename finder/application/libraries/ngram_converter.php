<?php

class Ngram_Converter{

	function __construct() {
		$this->CI =& get_instance();
	}

	function _to_ngram_fulltext($string,$n){
		$ngrams = array();
		$string = trim($string);
		if ($string == ''){
			return '';
		}
		
		$length = mb_strlen($string,'UTF-8') ;
		for ($i = 0; $i < $length; $i++) {
			$ngram = mb_substr($string, $i, $n,'UTF-8');
			$ngrams[] = $ngram;
		}
	
		return join(' ',$ngrams);
	}
	
	function _to_ngram_query($string,$n){
		$ngrams = array();
		$string = trim($string);
		if ($string == ''){
			return '';
		}
		$length = mb_strlen($string,'UTF-8') ;
		if ($length < $n){
			return "+".$string."*";
		}
	
		for ($i = 0; $i < $length-$n+1; $i++) {
			$ngram = mb_substr($string, $i, $n,'UTF-8');
			$ngrams[] = "+" . $ngram;
		}
	
		return join(' ',$ngrams);
	}
	
	function _to_ngram($string,$n,$query_flag=FALSE){
		$temp_encoding = mb_regex_encoding();
		mb_regex_encoding('UTF-8');
		$string = strtr ($string,array(
'、'=>' ','。'=>' ','，'=>' ','．'=>' ','・'=>' ','：'=>' ','；'=>' ','？'=>' ','！'=>' ','゛'=>' ','゜'=>' ','´'=>' ','｀'=>' ','¨'=>' ','＾'=>' ','￣'=>' ','＿'=>' ','ヽ'=>' ','ヾ'=>' ','ゝ'=>' ','ゞ'=>' ','〃'=>' ','仝'=>' ','々'=>' ','〆'=>' ','〇'=>' ','ー'=>' ','―'=>' ','‐'=>' ','／'=>' ','＼'=>' ','～'=>' ','∥'=>' ','｜'=>' ','…'=>' ','‥'=>' ','‘'=>' ','’'=>' ','“'=>' ','”'=>' ','（'=>' ','）'=>' ','〔'=>' ','〕'=>' ','［'=>' ','］'=>' ','｛'=>' ','｝'=>' ','〈'=>' ','〉'=>' ','《'=>' ','》'=>' ','「'=>' ','」'=>' ','『'=>' ','』'=>' ','【'=>' ','】'=>' ','＋'=>' ','－'=>' ','±'=>' ','×'=>' ','÷'=>' ','＝'=>' ','≠'=>' ','＜'=>' ','＞'=>' ','≦'=>' ','≧'=>' ','∞'=>' ','∴'=>' ','♂'=>' ','♀'=>' ','°'=>' ','′'=>' ','″'=>' ','℃'=>' ','￥'=>' ','＄'=>' ','￠'=>' ','￡'=>' ','％'=>' ','＃'=>' ','＆'=>' ','＊'=>' ','＠'=>' ','§'=>' ','☆'=>' ','★'=>' ','○'=>' ','●'=>' ','◎'=>' ','◇'=>' ','◆'=>' ','□'=>' ','■'=>' ','△'=>' ','▲'=>' ','▽'=>' ','▼'=>' ','※'=>' ','〒'=>' ','→'=>' ','←'=>' ','↑'=>' ','↓'=>' ','〓'=>' ','∈'=>' ','∋'=>' ','⊆'=>' ','⊇'=>' ','⊂'=>' ','⊃'=>' ','∪'=>' ','∩'=>' ','∧'=>' ','∨'=>' ','￢'=>' ','⇒'=>' ','⇔'=>' ','∀'=>' ','∃'=>' ','∠'=>' ','⊥'=>' ','⌒'=>' ','∂'=>' ','∇'=>' ','≡'=>' ','≒'=>' ','≪'=>' ','≫'=>' ','√'=>' ','∽'=>' ','∝'=>' ','∵'=>' ','∫'=>' ','∬'=>' ','Å'=>' ','‰'=>' ','♯'=>' ','♭'=>' ','♪'=>' ','†'=>' ','‡'=>' ','¶'=>' ','◯'=>' ','Α'=>' ','Β'=>' ','Γ'=>' ','Δ'=>' ','Ε'=>' ','Ζ'=>' ','Η'=>' ','Θ'=>' ','Ι'=>' ','Κ'=>' ','Λ'=>' ','Μ'=>' ','Ν'=>' ','Ξ'=>' ','Ο'=>' ','Π'=>' ','Ρ'=>' ','Σ'=>' ','Τ'=>' ','Υ'=>' ','Φ'=>' ','Χ'=>' ','Ψ'=>' ','Ω'=>' ','α'=>' ','β'=>' ','γ'=>' ','δ'=>' ','ε'=>' ','ζ'=>' ','η'=>' ','θ'=>' ','ι'=>' ','κ'=>' ','λ'=>' ','μ'=>' ','ν'=>' ','ξ'=>' ','ο'=>' ','π'=>' ','ρ'=>' ','σ'=>' ','τ'=>' ','υ'=>' ','φ'=>' ','χ'=>' ','ψ'=>' ','ω'=>' ','А'=>' ','Б'=>' ','В'=>' ','Г'=>' ','Д'=>' ','Е'=>' ','Ё'=>' ','Ж'=>' ','З'=>' ','И'=>' ','Й'=>' ','К'=>' ','Л'=>' ','М'=>' ','Н'=>' ','О'=>' ','П'=>' ','Р'=>' ','С'=>' ','Т'=>' ','У'=>' ','Ф'=>' ','Х'=>' ','Ц'=>' ','Ч'=>' ','Ш'=>' ','Щ'=>' ','Ъ'=>' ','Ы'=>' ','Ь'=>' ','Э'=>' ','Ю'=>' ','Я'=>' ','а'=>' ','б'=>' ','в'=>' ','г'=>' ','д'=>' ','е'=>' ','ё'=>' ','ж'=>' ','з'=>' ','и'=>' ','й'=>' ','к'=>' ','л'=>' ','м'=>' ','н'=>' ','о'=>' ','п'=>' ','р'=>' ','с'=>' ','т'=>' ','у'=>' ','ф'=>' ','х'=>' ','ц'=>' ','ч'=>' ','ш'=>' ','щ'=>' ','ъ'=>' ','ы'=>' ','ь'=>' ','э'=>' ','ю'=>' ','я'=>' ','─'=>' ','│'=>' ','┌'=>' ','┐'=>' ','┘'=>' ','└'=>' ','├'=>' ','┬'=>' ','┤'=>' ','┴'=>' ','┼'=>' ','━'=>' ','┃'=>' ','┏'=>' ','┓'=>' ','┛'=>' ','┗'=>' ','┣'=>' ','┳'=>' ','┫'=>' ','┻'=>' ','╋'=>' ','┠'=>' ','┯'=>' ','┨'=>' ','┷'=>' ','┿'=>' ','┝'=>' ','┰'=>' ','┥'=>' ','┸'=>' ','╂'=>' ','①'=>' ','②'=>' ','③'=>' ','④'=>' ','⑤'=>' ','⑥'=>' ','⑦'=>' ','⑧'=>' ','⑨'=>' ','⑩'=>' ','⑪'=>' ','⑫'=>' ','⑬'=>' ','⑭'=>' ','⑮'=>' ','⑯'=>' ','⑰'=>' ','⑱'=>' ','⑲'=>' ','⑳'=>' ','Ⅰ'=>' ','Ⅱ'=>' ','Ⅲ'=>' ','Ⅳ'=>' ','Ⅴ'=>' ','Ⅵ'=>' ','Ⅶ'=>' ','Ⅷ'=>' ','Ⅸ'=>' ','Ⅹ'=>' ','�'=>' ','㍉'=>' ','㌔'=>' ','㌢'=>' ','㍍'=>' ','㌘'=>' ','㌧'=>' ','㌃'=>' ','㌶'=>' ','㍑'=>' ','㍗'=>' ','㌍'=>' ','㌦'=>' ','㌣'=>' ','㌫'=>' ','㍊'=>' ','㌻'=>' ','㎜'=>' ','㎝'=>' ','㎞'=>' ','㎎'=>' ','㎏'=>' ','㏄'=>' ','㎡'=>' ','㍻'=>' ','〝'=>' ','〟'=>' ','№'=>' ','㏍'=>' ','℡'=>' ','㊤'=>' ','㊥'=>' ','㊦'=>' ','㊧'=>' ','㊨'=>' ','㈱'=>' ','㈲'=>' ','㈹'=>' ','㍾'=>' ','㍽'=>' ','㍼'=>' ','≒'=>' ','≡'=>' ','∫'=>' ','∮'=>' ','∑'=>' ','√'=>' ','⊥'=>' ','∠'=>' ','∟'=>' ','⊿'=>' ','∵'=>' ','∩'=>' ','∪'=>' ',
'!'=>' ','"'=>' ','#'=>' ','$'=>' ','%'=>' ','&'=>' ','\''=>' ','('=>' ',')'=>' ','*'=>' ','+'=>' ',','=>' ','-'=>' ','.'=>' ','/'=>' ',
':'=>' ',';'=>' ','<'=>' ','='=>' ','>'=>' ','?'=>' ','@'=>' ',
'{'=>' ','|'=>' ','}'=>' ','~'=>' ',
		));
		//$string = preg_replace("[!-\/:-@\[-`\{-~]",' ',$string);
		//$string = mb_ereg_replace("^(\s|　)+","",$string);
		//$string = mb_ereg_replace("(\s|　)+$","",$string);
		$str_array = preg_split("/(\s|　)+/",$string);
		mb_regex_encoding($temp_encoding);
	
		$result = array();
		foreach ($str_array as $str){
			if ($query_flag){
				$result[] = $this->_to_ngram_query($str,$n);
			}else{
				$result[] = $this->_to_ngram_fulltext($str,$n);
			}
		}
		return join(' ',$result);
	}
	
	function to_fulltext($string,$n){
		return $this->_to_ngram($string,$n);
	}
	
	function to_query($string,$n){
		return $this->_to_ngram($string,$n,TRUE);
	}

	function make_match_sql($word,$column,$n){
		if($word == ''){
			return '';
		}
		$ngram = $this->to_query($word,$n);
		return "MATCH(".$column.") AGAINST('".$ngram."' IN BOOLEAN MODE)";
	}
}
